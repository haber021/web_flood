{% extends "base.html" %}

{% block title %}Add Sensor{% endblock %}

{% block content %}
<div class="container py-4 form-card">
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Add New Sensor</h5>
        </div>
        <div class="card-body">
            <form method="post" novalidate>
                {% csrf_token %}

                <div class="form-row">
                    <div class="form-group">
                        <label for="id_name">Name:</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-tag"></i></span>
                            {{ form.name }}
                        </div>
                        {% if form.name.errors %}
                            <div class="text-danger small">{{ form.name.errors.as_text }}</div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label for="id_sensor_type">Sensor type:</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-thermometer-half"></i></span>
                            {{ form.sensor_type }}
                        </div>
                        {% if form.sensor_type.errors %}
                            <div class="text-danger small">{{ form.sensor_type.errors.as_text }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Coordinates:</label>
                        <div class="alert alert-info py-2" role="alert" style="font-size: 0.95rem;">
                            Latitude and Longitude will be set automatically based on the selected Barangay.
                        </div>
                        <div style="display:none;">{{ form.latitude }}{{ form.longitude }}</div>
                    </div>

                    <div class="form-group">
                        <label>&nbsp;</label>
                        <div class="form-check mt-2">
                            {{ form.active }} <label class="form-check-label ms-2" for="id_active">Active</label>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="id_municipality">Municipality:</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-city"></i></span>
                            {{ form.municipality }}
                        </div>
                        {% if form.municipality.errors %}
                            <div class="text-danger small">{{ form.municipality.errors.as_text }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex: 1 1 100%;">
                        <label for="id_barangay">Barangay: <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                            {{ form.barangay }}
                            <button type="button" class="btn btn-outline-secondary" id="add-new-barangay-btn" title="Add New Barangay">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        {% if form.barangay.errors %}<div class="text-danger small">{{ form.barangay.errors.as_text }}</div>{% endif %}
                        <small class="form-text text-muted">Select a municipality first, then choose or add a barangay. <strong>Barangay selection is required.</strong></small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex: 1 1 100%;">
                        <label for="id_description">Description:</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <div class="text-danger small">{{ form.description.errors.as_text }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Create Sensor</button>
                    <a href="{% url 'dashboard' %}" class="btn btn-secondary ms-2">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add New Barangay Modal -->
<div class="modal fade" id="addBarangayModal" tabindex="-1" aria-labelledby="addBarangayModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addBarangayModalLabel">Add New Barangay</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addBarangayForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="barangayName" class="form-label">Barangay Name *</label>
                        <input type="text" class="form-control" id="barangayName" required>
                    </div>
                    <div class="mb-3">
                        <label for="barangayMunicipality" class="form-label">Municipality *</label>
                        <select class="form-select" id="barangayMunicipality" required>
                            <option value="">Select Municipality</option>
                            {% for municipality in form.municipality.field.queryset %}
                                <option value="{{ municipality.id }}">{{ municipality.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="barangayPopulation" class="form-label">Population</label>
                        <input type="number" class="form-control" id="barangayPopulation" min="0">
                    </div>
                    <div class="mb-3">
                        <label for="barangayArea" class="form-label">Area (sq km)</label>
                        <input type="number" class="form-control" id="barangayArea" step="0.01" min="0">
                    </div>
                    <div class="mb-3">
                        <label for="barangayLatitude" class="form-label">Latitude</label>
                        <input type="number" class="form-control" id="barangayLatitude" step="0.000001" min="-90" max="90">
                    </div>
                    <div class="mb-3">
                        <label for="barangayLongitude" class="form-label">Longitude</label>
                        <input type="number" class="form-control" id="barangayLongitude" step="0.000001" min="-180" max="180">
                    </div>
                    <div class="mb-3">
                        <label for="barangayContactPerson" class="form-label">Contact Person</label>
                        <input type="text" class="form-control" id="barangayContactPerson">
                    </div>
                    <div class="mb-3">
                        <label for="barangayContactNumber" class="form-label">Contact Number</label>
                        <input type="tel" class="form-control" id="barangayContactNumber">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveBarangayBtn">Save Barangay</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
  document.addEventListener('DOMContentLoaded', function() {
    const muniSelect = document.getElementById('id_municipality');
    const brgySelect = document.getElementById('id_barangay');
    const latInput = document.getElementById('id_latitude');
    const lngInput = document.getElementById('id_longitude');

    let allBarangays = [];

    function populateBarangays(municipalityId) {
      brgySelect.innerHTML = '<option value="">---------</option>'; // Reset
      brgySelect.disabled = true;
      if (!municipalityId) return;

      fetch(`/api/all-barangays/?municipality_id=${municipalityId}`)
        .then(response => response.ok ? response.json() : Promise.reject('Failed to load barangays'))
        .then(data => {
          allBarangays = data.barangays || [];
          allBarangays.sort((a, b) => a.name.localeCompare(b.name));
          allBarangays.forEach(barangay => {
            const option = document.createElement('option');
            option.value = barangay.id;
            option.textContent = barangay.name;
            brgySelect.appendChild(option);
          });
          brgySelect.disabled = false;
        })
        .catch(error => {
          console.error('Error fetching barangays:', error);
          brgySelect.disabled = true;
        });
    }

    muniSelect.addEventListener('change', function() {
      populateBarangays(this.value);
    });

    brgySelect.addEventListener('change', function() {
      const selectedId = this.value;
      if (selectedId) {
        const barangay = allBarangays.find(b => String(b.id) === selectedId);
        if (barangay) {
          if (latInput && barangay.latitude != null) {
            latInput.value = barangay.latitude;
          }
          if (lngInput && barangay.longitude != null) {
            lngInput.value = barangay.longitude;
          }
        }
      }
    });

    // Initial population if a municipality is already selected
    if (muniSelect.value) {
      populateBarangays(muniSelect.value);
    }

    // Add New Barangay functionality
    const addBarangayBtn = document.getElementById('add-new-barangay-btn');
    const addBarangayModal = new bootstrap.Modal(document.getElementById('addBarangayModal'));
    const saveBarangayBtn = document.getElementById('saveBarangayBtn');
    const barangayForm = document.getElementById('addBarangayForm');

    addBarangayBtn.addEventListener('click', function() {
      // Set the municipality in the modal to match the selected municipality
      const barangayMunicipalitySelect = document.getElementById('barangayMunicipality');
      barangayMunicipalitySelect.value = muniSelect.value;

      // Clear previous form data
      barangayForm.reset();

      addBarangayModal.show();
    });

    saveBarangayBtn.addEventListener('click', function() {
      const formData = new FormData();
      formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
      formData.append('name', document.getElementById('barangayName').value);
      formData.append('municipality', document.getElementById('barangayMunicipality').value);
      formData.append('population', document.getElementById('barangayPopulation').value);
      formData.append('area_sqkm', document.getElementById('barangayArea').value);
      formData.append('latitude', document.getElementById('barangayLatitude').value);
      formData.append('longitude', document.getElementById('barangayLongitude').value);
      formData.append('contact_person', document.getElementById('barangayContactPerson').value);
      formData.append('contact_number', document.getElementById('barangayContactNumber').value);

      fetch('/api/create-barangay/', {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Close modal
          addBarangayModal.hide();

          // Show success message
          alert('Barangay created successfully!');

          // Refresh barangay dropdown
          if (muniSelect.value) {
            populateBarangays(muniSelect.value);
          }
        } else {
          // Show errors
          if (data.errors) {
            let errorMsg = 'Error creating barangay:\n';
            for (const [field, errors] of Object.entries(data.errors)) {
              errorMsg += `${field}: ${errors.join(', ')}\n`;
            }
            alert(errorMsg);
          } else {
            alert(data.message || 'Error creating barangay');
          }
        }
      })
      .catch(error => {
        console.error('Error creating barangay:', error);
        alert('Error creating barangay. Please try again.');
      });
    });
  });
})();
</script>
{% endblock %}
